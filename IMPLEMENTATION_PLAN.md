# План реализации загрузки цен через Excel/CSV и переименования элементов

## Анализ текущего состояния проекта

### Текущая структура:
- **Компонентов:** 25 позиций (корпуса, фурнитура, механизмы и т.д.)
- **Типов фасадов:** 14 вариантов
- **Типов столешниц:** 4 варианта (2 с автоматическим расчетом, 2 с ручным вводом)
- **Хранение данных:** localStorage (prices, countertopPrices, config)
- **Существующий функционал:** JSON импорт/экспорт цен

### Требования:
1. Создать Excel-шаблон для загрузки цен на все типы фасадов и компонентов
2. Реализовать импорт цен из CSV формата
3. Сохранить существующие кнопки импорта/экспорта JSON
4. Добавить возможность переименования типов фасадов
5. Добавить возможность переименования столешниц

---

## ЗАДАЧА 1: Создание функции генерации CSV-шаблона для загрузки цен
**Время:** 3 часа
**Приоритет:** Высокий

### Описание:
Разработать функцию `downloadPriceTemplate()` для генерации CSV-шаблона с правильной кодировкой UTF-8 BOM (для корректного отображения кириллицы в Excel).

### Структура CSV-файла:
```csv
Компонент ID,Название компонента,Единица,Категория,МДФ Мыло 3,4,5,МДФ 345 Premium,...
1,Нижний модуль,п.м.,Корпуса,0,0,...
2,Верхний модуль 720 мм,п.м.,Корпуса,0,0,...
...
```

### Технические детали:
- Первая строка: заголовки с названиями фасадов из `config.facades`
- Первые 4 колонки: ID, Название, Единица, Категория
- Далее колонки для каждого типа фасада (14 колонок)
- 25 строк данных компонентов
- Дополнительный блок для столешниц ЛДСП (ldsp_28, ldsp_40)

### Критерии приемки:
- [ ] Функция генерирует CSV с UTF-8 BOM
- [ ] Все названия фасадов в заголовках
- [ ] Все 25 компонентов в строках
- [ ] Отдельный блок для столешниц
- [ ] Файл корректно открывается в Excel без кракозябр
- [ ] Кнопка "Скачать шаблон Excel/CSV" добавлена в UI

### Место реализации:
`docs/index.html` - после функции `exportPrices()` (строка ~2120)

---

## ЗАДАЧА 2: Реализация импорта цен из CSV
**Время:** 4 часа
**Приоритет:** Высокий

### Описание:
Создать функцию `importPricesFromCSV(event)` для парсинга загруженного CSV-файла и импорта цен в систему.

### Технические детали:
- Использовать FileReader API для чтения файла
- Парсинг CSV: разделитель - запятая, поддержка кавычек
- Сопоставление колонок с фасадами по названиям из заголовка
- Валидация данных (проверка числовых значений)
- Обработка отрицательных цен (для скидок на углы)

### Алгоритм:
1. Прочитать файл как текст (UTF-8)
2. Разбить на строки
3. Первая строка = заголовки (извлечь названия фасадов)
4. Создать маппинг: индекс колонки → ID фасада
5. Для каждой строки данных:
   - Извлечь ID компонента (1-я колонка)
   - Для каждого фасада: сохранить цену в `prices[facadeId][componentId]`
6. Найти блок столешниц и импортировать в `countertopPrices`
7. Сохранить в localStorage
8. Обновить UI

### Обработка ошибок:
- Неверный формат файла
- Отсутствующие обязательные колонки
- Невалидные числовые значения
- Несовпадение количества компонентов

### Критерии приемки:
- [ ] CSV корректно парсится
- [ ] Цены импортируются в объект `prices`
- [ ] Цены столешниц импортируются в `countertopPrices`
- [ ] Данные сохраняются в localStorage
- [ ] Показывается сообщение об успехе/ошибке
- [ ] UI обновляется после импорта
- [ ] Кнопка "Импорт из CSV" добавлена рядом с JSON-импортом

### Место реализации:
`docs/index.html` - после функции `importPrices()` (строка ~2172)

---

## ЗАДАЧА 3: Обновление UI панели управления ценами
**Время:** 2 часа
**Приоритет:** Средний

### Описание:
Добавить кнопки для работы с CSV в существующую панель управления ценами (функция `showPricesPanel()`).

### Изменения в UI:
Текущие кнопки (строка ~1888):
```javascript
<button onclick="savePrices()">Сохранить все цены</button>
<button onclick="exportPrices()">Экспорт в JSON</button>
<button onclick="...">Импорт из JSON</button>
```

Новая структура кнопок:
```javascript
<button onclick="savePrices()">Сохранить все цены</button>
<div style="margin-top: 10px;">
  <h4>Формат JSON:</h4>
  <button onclick="exportPrices()">Экспорт в JSON</button>
  <button onclick="...">Импорт из JSON</button>
</div>
<div style="margin-top: 10px;">
  <h4>Формат Excel/CSV:</h4>
  <button onclick="downloadPriceTemplate()">Скачать шаблон Excel/CSV</button>
  <button onclick="...">Импорт из CSV</button>
  <input type="file" id="importCsvFile" accept=".csv" style="display:none;">
</div>
```

### Дополнительно:
- Добавить поясняющий текст о формате CSV
- Инструкция: "Скачайте шаблон → заполните цены в Excel → сохраните как CSV → загрузите обратно"

### Критерии приемки:
- [ ] Кнопки логически сгруппированы
- [ ] Понятные названия кнопок
- [ ] Есть краткая инструкция
- [ ] UI сохраняет существующий стиль
- [ ] Все кнопки функциональны

### Место реализации:
`docs/index.html` - функция `showPricesPanel()` (строка ~1837)

---

## ЗАДАЧА 4: Создание UI для переименования фасадов
**Время:** 3 часа
**Приоритет:** Средний

### Описание:
Добавить отдельную секцию в админ-панели для управления названиями фасадов.

### UI компонент:
Создать новую секцию в `showPricesPanel()` или отдельную функцию `showConfigPanel()`:

```
┌─ Управление названиями фасадов ─────────────┐
│                                              │
│  ID: mdf_mylo                                │
│  Название: [МДФ Мыло 3,4,5        ] [Изм.]  │
│                                              │
│  ID: mdf_premium                             │
│  Название: [МДФ 345 Premium       ] [Изм.]  │
│  ...                                         │
│                                              │
│  [Сбросить все названия]                    │
└──────────────────────────────────────────────┘
```

### Технические детали:
- Отображать все 14 фасадов из `config.facades`
- Поля ввода для редактирования названий
- Кнопка "Изменить" для каждого фасада
- Функция `renameFacade(facadeId, newName)`
- Сохранение в `customFacadeNames` (новый объект в localStorage)
- Функция `resetFacadeNames()` для возврата к дефолтным значениям

### Логика работы:
1. При загрузке проверять наличие `customFacadeNames` в localStorage
2. Если есть - использовать кастомные названия
3. Если нет - использовать дефолтные из `config.facades`
4. При переименовании - сохранять в localStorage
5. Обновлять все UI-компоненты, где используются названия фасадов

### Критерии приемки:
- [ ] Таблица/список всех фасадов с полями для редактирования
- [ ] Функция `renameFacade()` работает корректно
- [ ] Изменения сохраняются в localStorage
- [ ] Названия обновляются во всех частях UI (калькулятор, матрица сравнения, экспорт)
- [ ] Кнопка сброса названий работает
- [ ] При экспорте CSV используются актуальные названия

### Место реализации:
`docs/index.html` - новая секция после управления ценами

---

## ЗАДАЧА 5: Создание UI для переименования столешниц
**Время:** 2 часа
**Приоритет:** Средний

### Описание:
Аналогично задаче 4, но для столешниц (4 позиции).

### UI компонент:
```
┌─ Управление названиями столешниц ───────────┐
│                                              │
│  ID: ldsp_28                                 │
│  Название: [ЛДСП 28мм             ] [Изм.]  │
│                                              │
│  ID: ldsp_40                                 │
│  Название: [ЛДСП 40мм             ] [Изм.]  │
│                                              │
│  ID: acrylic                                 │
│  Название: [Акрил                 ] [Изм.]  │
│                                              │
│  ID: quartz                                  │
│  Название: [Кварц                 ] [Изм.]  │
│                                              │
│  [Сбросить все названия]                    │
└──────────────────────────────────────────────┘
```

### Технические детали:
- 4 столешницы из `config.countertops`
- Функция `renameCountertop(countertopId, newName)`
- Сохранение в `customCountertopNames` (localStorage)
- Функция `resetCountertopNames()`

### Критерии приемки:
- [ ] Список всех столешниц с полями редактирования
- [ ] Функция `renameCountertop()` работает
- [ ] Сохранение в localStorage
- [ ] Обновление названий в калькуляторе, матрице сравнения
- [ ] Кнопка сброса работает

### Место реализации:
`docs/index.html` - рядом с секцией фасадов

---

## ЗАДАЧА 6: Рефакторинг функций отображения для поддержки кастомных названий
**Время:** 3 часа
**Приоритет:** Высокий

### Описание:
Обновить все функции, где используются названия фасадов и столешниц, чтобы они брали актуальные названия (дефолтные или кастомные).

### Функции, требующие изменений:
1. `showCalculator()` - селектор фасадов и столешниц
2. `renderComparisonMatrix()` - заголовки таблицы
3. `showPricesPanel()` - селектор фасадов
4. `downloadPriceTemplate()` - заголовки CSV
5. `exportCalculationToPDF()` - названия в PDF (если есть)
6. Все функции отображения расчетов

### Создать вспомогательные функции:
```javascript
// Получить актуальное название фасада
function getFacadeName(facadeId) {
    const customNames = JSON.parse(localStorage.getItem('customFacadeNames') || '{}');
    if (customNames[facadeId]) {
        return customNames[facadeId];
    }
    const facade = config.facades.find(f => f.id === facadeId);
    return facade ? facade.name : facadeId;
}

// Получить актуальное название столешницы
function getCountertopName(countertopId) {
    const customNames = JSON.parse(localStorage.getItem('customCountertopNames') || '{}');
    if (customNames[countertopId]) {
        return customNames[countertopId];
    }
    const countertop = config.countertops.find(c => c.id === countertopId);
    return countertop ? countertop.name : countertopId;
}
```

### Критерии приемки:
- [ ] Функции `getFacadeName()` и `getCountertopName()` реализованы
- [ ] Все части UI используют эти функции
- [ ] При изменении названия обновляются все разделы
- [ ] Экспорт CSV/JSON использует актуальные названия
- [ ] Импорт корректно работает с кастомными названиями

### Место реализации:
`docs/index.html` - добавить функции в начале блока управления ценами

---

## ЗАДАЧА 7: Тестирование и документация
**Время:** 3 часа
**Приоритет:** Средний

### Описание:
Провести комплексное тестирование всех новых функций и создать документацию для пользователей.

### Тестовые сценарии:

#### 7.1. Тестирование CSV импорта/экспорта
- [ ] Скачать шаблон CSV
- [ ] Открыть в Excel, проверить корректность отображения кириллицы
- [ ] Заполнить цены (включая отрицательные для скидок)
- [ ] Сохранить как CSV (UTF-8)
- [ ] Импортировать обратно
- [ ] Проверить корректность загруженных цен
- [ ] Провести расчет с новыми ценами

#### 7.2. Тестирование переименования
- [ ] Переименовать несколько фасадов
- [ ] Проверить обновление в селекторе калькулятора
- [ ] Проверить обновление в матрице сравнения
- [ ] Скачать CSV-шаблон - проверить новые названия в заголовках
- [ ] Сбросить названия - проверить возврат к дефолтным
- [ ] Переименовать столешницы - проверить обновление в UI

#### 7.3. Тестирование совместимости
- [ ] Проверить работу JSON импорта/экспорта (не должен сломаться)
- [ ] Проверить сохранение расчетов с новыми ценами
- [ ] Проверить историю расчетов
- [ ] Проверить работу в разных браузерах (Chrome, Firefox, Safari)

#### 7.4. Тестирование граничных случаев
- [ ] Импорт пустого CSV
- [ ] Импорт CSV с неверным форматом
- [ ] Импорт CSV с отсутствующими колонками
- [ ] Очень длинные названия фасадов/столешниц
- [ ] Специальные символы в названиях

### Документация:
Создать файл `docs/USER_GUIDE_CSV.md`:
- Инструкция по загрузке цен через CSV
- Структура CSV-файла
- Правила заполнения
- Инструкция по переименованию
- FAQ и troubleshooting

### Критерии приемки:
- [ ] Все тестовые сценарии пройдены
- [ ] Найденные баги исправлены
- [ ] Документация создана
- [ ] README.md обновлен с описанием новых функций

---

## ЗАДАЧА 8 (опциональная): Улучшение UX и визуальные доработки
**Время:** 2 часа
**Приоритет:** Низкий

### Описание:
Улучшить пользовательский опыт при работе с новыми функциями.

### Улучшения:
1. **Индикатор загрузки** при импорте большого CSV
2. **Превью данных** перед импортом (показать первые 5 строк)
3. **Валидация в реальном времени** при редактировании названий
4. **Подсказки (tooltips)** для кнопок и полей
5. **История изменений** названий (кто, когда изменил)
6. **Drag & Drop** для загрузки CSV файлов
7. **Прогресс-бар** при импорте

### Критерии приемки:
- [ ] Добавлено минимум 3 улучшения из списка
- [ ] UX стал более интуитивным
- [ ] Нет ухудшения производительности

---

## Итоговая структура изменений в index.html

### Новые функции:
```javascript
// CSV функции
function downloadPriceTemplate()
function importPricesFromCSV(event)
function parseCSV(csvText)

// Функции переименования
function renameFacade(facadeId, newName)
function renameCountertop(countertopId, newName)
function resetFacadeNames()
function resetCountertopNames()

// Вспомогательные функции
function getFacadeName(facadeId)
function getCountertopName(countertopId)
function loadCustomNames()
function saveCustomNames()

// UI функции
function showConfigPanel() // или интеграция в showPricesPanel()
function renderFacadeRenameUI()
function renderCountertopRenameUI()
```

### Изменения localStorage:
- `prices` - существующий (цены компонентов по фасадам)
- `countertopPrices` - существующий (цены столешниц)
- `customFacadeNames` - **новый** (кастомные названия фасадов)
- `customCountertopNames` - **новый** (кастомные названия столешниц)

---

## Порядок выполнения задач

### Этап 1: CSV функционал (критический путь)
1. **ЗАДАЧА 1** - Генерация CSV-шаблона (3ч)
2. **ЗАДАЧА 2** - Импорт из CSV (4ч)
3. **ЗАДАЧА 3** - Обновление UI кнопок (2ч)

**Итого: 9 часов** → После этого можно тестировать базовый CSV импорт/экспорт

### Этап 2: Функционал переименования
4. **ЗАДАЧА 6** - Рефакторинг для поддержки кастомных имен (3ч)
5. **ЗАДАЧА 4** - UI переименования фасадов (3ч)
6. **ЗАДАЧА 5** - UI переименования столешниц (2ч)

**Итого: 8 часов** → После этого можно переименовывать элементы

### Этап 3: Тестирование и полировка
7. **ЗАДАЧА 7** - Тестирование и документация (3ч)
8. **ЗАДАЧА 8** - UX улучшения (опционально, 2ч)

**Итого: 5 часов**

---

## Общая оценка времени

- **Обязательные задачи:** 22 человеко-часа (≈ 3 рабочих дня)
- **С опциональными:** 24 человеко-часа

---

## Риски и зависимости

### Риски:
1. **Кодировка CSV** - Excel может некорректно открывать UTF-8 без BOM
   - Решение: использовать UTF-8 BOM при генерации
2. **Парсинг CSV** - значения могут содержать запятые в кавычках
   - Решение: использовать проверенную библиотеку или собственный парсер с обработкой кавычек
3. **Кеширование** - браузер может кешировать старые названия
   - Решение: сброс кеша или версионирование localStorage

### Зависимости:
- ЗАДАЧА 2 зависит от ЗАДАЧИ 1 (нужна структура CSV)
- ЗАДАЧА 4 и 5 зависят от ЗАДАЧИ 6 (нужны вспомогательные функции)
- ЗАДАЧА 7 зависит от всех предыдущих

---

## Критерии успешного завершения

### Функциональные требования:
- ✅ Администратор может скачать CSV-шаблон с актуальными названиями фасадов
- ✅ Шаблон корректно открывается в Excel без кракозябр
- ✅ После заполнения цен файл можно загрузить обратно в калькулятор
- ✅ Цены импортируются корректно (включая отрицательные для скидок)
- ✅ Администратор может переименовать любой фасад или столешницу
- ✅ Новые названия отображаются во всех частях системы
- ✅ Существующий JSON импорт/экспорт продолжает работать
- ✅ Все данные сохраняются в localStorage

### Технические требования:
- ✅ Код соответствует существующему стилю проекта
- ✅ Нет дублирования кода
- ✅ Все функции документированы комментариями
- ✅ Обработаны все возможные ошибки
- ✅ UI адаптивен и работает на мобильных устройствах
- ✅ Нет регрессии существующего функционала

---

## Следующие шаги

После утверждения плана:
1. Создать ветку `feature/csv-import-rename` в Git
2. Реализовать задачи в указанном порядке
3. После каждой задачи делать коммит с осмысленным сообщением
4. После этапа 1 - промежуточное тестирование и демо
5. После этапа 2 - финальное тестирование
6. Merge в main и deploy на GitHub Pages
